<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Typing</title>
    <script>
      let t;

      let wpm = JSON.parse(window.localStorage.getItem("wpm"))
        ? JSON.parse(window.localStorage.getItem("wpm"))
        : [];

      const promiseA = new Promise(async (resolve, reject) => {
        let words;

        let wordsPromise = await fetch("./words3.txt");
        if (wordsPromise.ok) {
          let wordsString = await wordsPromise.text();
          words = wordsString.split("\n");
          resolve(words);
        }
        reject("Failed");
      });
      window.onload = async function () {
        t = new Date();
        changeWord();
      };

      async function changeWord() {
        let words = await promiseA;

        let wordString = "";

        document.getElementById("max").innerHTML = document.getElementById(
          "myRange"
        ).value;

        for (let i = 0; i < 5; i++) {
          let j = words.length;
          while (true) {
            let wordTest = words[getRandomInt(words.length - 1)];
            if (wordTest.length == document.getElementById("myRange").value) {
              wordString += wordTest.toLowerCase() + " ";
              break;
            }
            if (j == 0) {
              wordString = "No words";
              break;
            }

            j--;
          }

          if (j == 0) break;
        }

        document.getElementById("hiddenWord").innerHTML = wordString;

        makeGreen();
      }

      function getRandomInt(max) {
        return Math.floor(Math.random() * Math.floor(max));
      }

      async function tryWord(doc) {
        makeGreen();
        let tmp = new Date();
        console.log(doc.value.length);
        if (doc.value.length == 1) {
          t = new Date();
          console.log("New date");
        }
        if (
          checkWordAtLength(
            document.getElementById("hiddenWord").innerHTML.length - 1
          )
        ) {
          //console.log(doc.value.length / (tmp.getTime() - t.getTime()));
          let wordsUnit = (doc.value.length - 1) / 5;

          let secondsUnit = (tmp.getTime() - t.getTime()) / 1000;

          let minutesUnit = secondsUnit / 60;

          wpm.push(wordsUnit / minutesUnit);

          console.log(wordsUnit / minutesUnit);
          if (wpm.length > 20) wpm.shift();
          let color = wordsUnit / minutesUnit >= average(wpm) ? "green" : "red";
          document.getElementById("wpm").innerHTML =
            '<a style="color: ' +
            color +
            ';">' +
            (wordsUnit / minutesUnit).toFixed(1) +
            "</a>" +
            " (Average: " +
            average(wpm).toFixed(1) +
            ")";

          let myRange = document.getElementById("myRange");

          console.log(color + " " + myRange.value + " " + myRange.max);

          if (color == "green") {
            myRange.value = myRange.value - -1; // Funkar inte med + 1
            console.log("Added");
            let audio = new Audio("./success.mp3");
            audio.play();
          }
          if (color == "red") {
            myRange.value = myRange.value - 1;
            console.log("Removed");
          }

          changeWord();
          doc.value = "";
          t = new Date();

          window.localStorage.setItem("wpm", JSON.stringify(wpm));

          console.log(wpm);
        }
      }

      async function makeGreen() {
        /*document.getElementById("word").innerHTML = document.getElementById(
          "hiddenWord"
        ).innerHTML;*/

        let inputLength = document.getElementById("input").value.length;

        let wordLength = document.getElementById("hiddenWord").innerHTML.length;

        let color;

        if (checkWordAtLength(inputLength)) {
          color = "green";
        } else {
          let audio = new Audio("./error.mp3");
          audio.play();

          color = "red";
          document.getElementById("input").style.backgroundColor = "red";
          setTimeout(function () {
            document.getElementById("input").style.backgroundColor = "white";
          }, 300);
        }

        document.getElementById(
          "word"
        ).innerHTML = `<a style="color: ${color}">${document
          .getElementById("hiddenWord")
          .innerHTML.substring(0, inputLength)}</a><a>${document
          .getElementById("hiddenWord")
          .innerHTML.substring(inputLength, wordLength)}</a>`;
      }

      function checkWordAtLength(len) {
        return (
          document.getElementById("input").value.toLowerCase() ==
          document.getElementById("hiddenWord").innerHTML.substring(0, len)
        );
      }

      let average = (array) => array.reduce((a, b) => a + b) / array.length;
    </script>

    <style>
      * {
        font-size: 50px;
        font-family: sans-serif;
      }

      #input {
        width: 75%;
      }

      #myRange {
        width: 75%;
      }
    </style>
  </head>
  <body id="body">
    <div id="main">
      <div id="hiddenWord" hidden></div>
      <p id="word">Waiting for network...</p>
      <button onclick="changeWord()" hidden>Change word</button>
      <input id="input" oninput="tryWord(this)" type="text" /> <br />
      <input
        type="range"
        min="3"
        max="13"
        value="3"
        class="slider"
        id="myRange"
        oninput="changeWord()"
        hidden
      />
      <br />
      Length of words:
      <p id="max"></p>
      WPM:
      <p id="wpm">Type the words to get words per minute</p>
    </div>
  </body>
</html>
